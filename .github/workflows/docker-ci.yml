name: Publish Docker image
on:
  push

# env:
#   DOCKER_BUILDKIT: 1
#   IMAGE_NAME: sample-image

jobs:
#   push_to_registry:
#     name: Push Docker image to GitHub Packages
#     runs-on: ubuntu-latest
#     steps:
#       - name: Check out the repo
#         uses: actions/checkout@v2
#       - name: Push to GitHub Packages
#         uses: docker/build-push-action@v1
#         with:
#           username: ${{ github.actor }}
#           password: ${{ secrets.GHCR_PAT }}
#           registry: ghcr.io
#           repository: ${{ github.repository }}/sample-image
#           tag_with_sha: true
#         env:
#           DOCKER_BUILDKIT: 1

  dockle:
      name: Dockle
      runs-on: ubuntu-18.04
      # needs: build TODO あとでいれる
      steps:
        - uses: actions/checkout@master

        # - name: Login GitHub Registry
        #   run: cat ${{ secrets.GHCR_PAT }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin

        # - name: Pull image from GitHub Registry
        #   run: docker pull ghcr.io/${{ github.repository }}/sample-image:${{ github.sha}}

        - name: Install dockle
          run: |
            VERSION=$(curl --silent "https://api.github.com/repos/goodwithtech/dockle/releases/latest" | \
            grep '"tag_name":' | \
            sed -E 's/.*"v([^"]+)".*/\1/' \
            )
            curl -L -o dockle.deb https://github.com/goodwithtech/dockle/releases/download/v${VERSION}/dockle_${VERSION}_Linux-64bit.deb
            sudo dpkg -i dockle.deb
            rm dockle.deb

        - name: Check image with dockle
          run: dockle ghcr.io/${{ github.repository }}/sample-image:${{ github.sha}}
